<!DOCTYPE html>
<html>
  <head> </head>
  <body>
    <canvas id="canvas"></canvas>
    <div style="display:none;">
      <img src="img/knob.png" id="knob" />
      <img src="img/node.png" id="node" />
    </div>
    <script src="lib/fabric.js"></script>
    <script>
      const nodeImgElement = document.getElementById("node")
      const knobImgElement = document.getElementById("knob")
      const network = [3, 4, 2]

      function getRandomInt(max) {
        min = 0
        max = Math.floor(max)
        return Math.floor(Math.random() * (max - min + 1)) + min
      }

      function switchDraggingMode(element) {
        element.lockMovementX = !element.lockMovementX
        element.lockMovementY = !element.lockMovementY
      }

      function switchDraggingModeForList(list) {
        list.forEach(elem => switchDraggingMode(elem))
      }

      function shuffle(array) {
        return array.sort(() => Math.random() - 0.5)
      }

      var canvas = new fabric.Canvas("canvas")
      canvas.selection = false
      window.addEventListener("resize", resizeCanvas, false)

      function resizeCanvas() {
        canvas.setHeight(window.innerHeight)
        canvas.setWidth(window.innerWidth)
        canvas.renderAll()
      }

      // resize on init
      resizeCanvas()

      let networkNodes = []
      for (let layer = 0; layer < network.length; layer++) {
        let nodes = []
        let left =
          canvas.width * 0.1 + ((canvas.width * 0.9) / network.length) * layer
        for (let i = 0; i < network[layer]; i++) {
          var node = new fabric.Image(nodeImgElement, {
            left: left,
            top:
              ((canvas.height * 0.8) / network[layer]) * i +
              canvas.height * 0.1,
            originX: "center",
            originY: "center",
            selectable: false
          })

          node.scaleToWidth(canvas.height / 20)
          node.scaleToHeight(canvas.height / 20)
          nodes.push(node)
          canvas.add(node)
        }
        networkNodes.push(nodes)
      }

      let networkKnobs = [],
        networkLines = []
      for (let layer = 0; layer < network.length - 1; layer++) {
        const layer1 = networkNodes[layer]
        const layer2 = networkNodes[layer + 1]
        let knobs = [],
          lines = []
        for (let layer1Index = 0; layer1Index < layer1.length; layer1Index++) {
          for (
            let layer2Index = 0;
            layer2Index < layer2.length;
            layer2Index++
          ) {
            let knob = new fabric.Image(knobImgElement, {
              left:
                layer1[layer1Index].left +
                (layer2[layer2Index].left - layer1[layer1Index].left) * 0.8,
              top:
                layer1[layer1Index].top +
                (layer2[layer2Index].top - layer1[layer1Index].top) * 0.8,
              originX: "center",
              originY: "center"
            })
            knob.setControlsVisibility({
              mt: false,
              mb: false,
              ml: false,
              mr: false,
              tr: false,
              tl: false,
              br: false,
              bl: false,
              mtr: true //the rotating point (defaut: true)
            })
            knob.lockMovementX = knob.lockMovementY = true
            knob.scaleToWidth(canvas.height / 24)
            knob.scaleToHeight(canvas.height / 24)
            knobs.push(knob)

            let points1 = [
              layer1[layer1Index].left,
              layer1[layer1Index].top,
              knob.left,
              knob.top
            ]
            let points2 = [
              knob.left,
              knob.top,
              layer2[layer2Index].left,
              layer2[layer2Index].top
            ]

            let line1 = new fabric.Line(points1, {
              strokeWidth: 10,
              stroke: "black",
              selectable: false
            })
            let line2 = new fabric.Line(points2, {
              strokeWidth: 3,
              stroke: "black",
              selectable: false
            })
            lines.push({
              to: line1,
              from: line2
            })
            canvas.add(line1)
            canvas.add(line2)
            canvas.add(knob)
          }
        }
        networkKnobs.push(knobs)
        networkLines.push(lines)
      }
    </script>
  </body>
</html>
